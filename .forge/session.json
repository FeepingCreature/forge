{
  "messages": [
    {
      "role": "user",
      "content": "Implement a \"mood bar\" widget that visualizes prompt token usage with color-coded segments.\n\n## Overview\nCreate a horizontal bar widget that shows how the prompt token budget is being used, with different colored segments for different content types. It should be placed in the main window's status area and toggle visibility via the View menu's \"Show Mood Bar\" action.\n\n## Files to create/modify\n\n### 1. Create `forge/ui/mood_bar.py` - New widget\n\nCreate a `MoodBar(QWidget)` class that:\n- Displays horizontal colored segments proportional to token usage\n- Each segment represents a content type (system prompt, summaries, files, conversation)\n- Shows tooltips on hover with: segment name, token count, percentage\n- Has a fixed height (~20px) and expands horizontally\n\nColor scheme (use these exact colors):\n- System prompt: `#6366f1` (indigo)\n- Summaries: `#8b5cf6` (violet) \n- Files: `#06b6d4` (cyan)\n- Conversation: `#10b981` (emerald)\n- Empty/unused: `#374151` (gray)\n\nInterface:\n```python\nclass MoodBar(QWidget):\n    def __init__(self, parent=None):\n        ...\n    \n    def set_segments(self, segments: list[dict]) -> None:\n        \"\"\"Set segments to display.\n        \n        Each segment dict has:\n        - name: str (e.g., \"System prompt\")\n        - tokens: int\n        - color: str (hex color)\n        - details: str (optional, for tooltip)\n        \"\"\"\n        ...\n```\n\nImplementation:\n- Override `paintEvent` to draw colored rectangles\n- Override `event` to handle `QEvent.ToolTip` for segment-specific tooltips\n- Store segments and total tokens for proportion calculation\n- Use `QPainter` with `fillRect` for segments\n\n### 2. Modify `forge/ui/main_window.py`\n\n1. Import MoodBar: `from forge.ui.mood_bar import MoodBar`\n\n2. In `_setup_ui()`, after creating the status bar, add the mood bar:\n```python\n# Add mood bar to status bar\nself._mood_bar = MoodBar()\nself._mood_bar.setFixedHeight(20)\nself._mood_bar.setMinimumWidth(200)\nself.statusBar().addPermanentWidget(self._mood_bar)\n```\n\n3. Update `_toggle_mood_bar` to actually show/hide:\n```python\ndef _toggle_mood_bar(self, checked: bool) -> None:\n    self._mood_bar_visible = checked\n    self._mood_bar.setVisible(checked)\n```\n\n4. In `_on_context_stats_updated`, call a new method to update the mood bar with the stats.\n\n5. Add method to update mood bar from context stats (you'll need to parse the stats or get raw data):\n```python\ndef _update_mood_bar(self, system_tokens: int, summary_tokens: int, file_tokens: int, conversation_tokens: int) -> None:\n    segments = [\n        {\"name\": \"System\", \"tokens\": system_tokens, \"color\": \"#6366f1\"},\n        {\"name\": \"Summaries\", \"tokens\": summary_tokens, \"color\": \"#8b5cf6\"},\n        {\"name\": \"Files\", \"tokens\": file_tokens, \"color\": \"#06b6d4\"},\n        {\"name\": \"Conversation\", \"tokens\": conversation_tokens, \"color\": \"#10b981\"},\n    ]\n    self._mood_bar.set_segments(segments)\n```\n\n### 3. Check how context stats are passed\n\nLook at how `_on_context_stats_updated` currently works. It receives stats from somewhere - you may need to modify the signal to pass the raw token counts instead of just a formatted string, OR parse them from the string.\n\nThe stats come from `PromptManager.to_messages()` which returns token counts. Trace back to find where these are emitted and ensure the mood bar can access the breakdown.\n\n## Expected behavior\n- Mood bar appears in status bar area\n- Shows colored segments proportional to token usage\n- Hovering over a segment shows tooltip with name and token count\n- View > Show Mood Bar toggles visibility\n- Updates whenever a new request is made\n\n## Run check at the end\nRun `<check/>` to verify no type errors."
    }
  ],
  "active_files": [],
  "parent_session": "master",
  "child_sessions": [],
  "state": "running",
  "yield_message": null
}